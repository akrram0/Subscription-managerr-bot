<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÿ•ÿ∂ÿßŸÅÿ© ÿßÿ¥ÿ™ÿ±ÿßŸÉ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #111008);
            --tg-text: var(--tg-theme-text-color, #f2ede4);
            --tg-hint: var(--tg-theme-hint-color, #7a7060);
            --tg-btn: var(--tg-theme-button-color, #c95c1a);
            --tg-btn-text: var(--tg-theme-button-text-color, #fff);
            --tg-secondary: var(--tg-theme-secondary-bg-color, #1c1a12);

            --accent: #d4621e;
            --accent-light: #f07830;
            --accent-glow: rgba(212, 98, 30, 0.35);
            --accent-2: #f0a050;
            --accent-2-glow: rgba(240, 160, 80, 0.18);
            --circuit-line: rgba(212, 98, 30, 0.25);
            --surface: rgba(255, 248, 235, 0.04);
            --surface-2: rgba(255, 248, 235, 0.07);
            --border: rgba(212, 98, 30, 0.18);
            --border-focus: rgba(212, 98, 30, 0.7);
            --danger: #e05050;
            --success: #7ec87e;
            --cream: #f2ede4;
            --radius: 14px;
            --radius-sm: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'IBM Plex Sans Arabic', -apple-system, sans-serif;
            background: var(--tg-bg);
            color: var(--tg-text);
            min-height: 100dvh;
            overflow-x: hidden;
            position: relative;
        }

        /* === BACKGROUND CIRCUIT === */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse 70% 50% at 90% -5%, rgba(212,98,30,0.14) 0%, transparent 60%),
                radial-gradient(ellipse 50% 40% at -10% 100%, rgba(240,160,80,0.08) 0%, transparent 55%);
            pointer-events: none;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                repeating-linear-gradient(0deg, transparent, transparent 48px, rgba(212,98,30,0.055) 48px, rgba(212,98,30,0.055) 49px),
                repeating-linear-gradient(90deg, transparent, transparent 48px, rgba(212,98,30,0.055) 48px, rgba(212,98,30,0.055) 49px);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            padding: 20px 16px 100px;
            max-width: 480px;
            margin: 0 auto;
        }

        /* === HEADER === */
        .header {
            text-align: center;
            margin-bottom: 28px;
            animation: fadeSlideDown 0.5s ease both;
        }

        .header-icon {
            width: 72px;
            height: 72px;
            margin: 0 auto 14px;
            background: #111008;
            border: 1.5px solid rgba(212,98,30,0.5);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow:
                0 0 0 4px rgba(212,98,30,0.08),
                0 8px 32px rgba(212,98,30,0.25),
                inset 0 1px 0 rgba(255,255,255,0.06);
            animation: iconPulse 3s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }

        /* Circuit S logo SVG inside icon */
        .header-icon svg {
            width: 44px;
            height: 44px;
        }

        @keyframes iconPulse {
            0%, 100% { box-shadow: 0 0 0 4px rgba(212,98,30,0.08), 0 8px 32px rgba(212,98,30,0.25), inset 0 1px 0 rgba(255,255,255,0.06); }
            50% { box-shadow: 0 0 0 6px rgba(212,98,30,0.14), 0 8px 48px rgba(212,98,30,0.4), inset 0 1px 0 rgba(255,255,255,0.08); }
        }

        .header h1 {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            background: linear-gradient(135deg, var(--cream) 40%, var(--accent-2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 13px;
            color: var(--tg-hint);
            margin-top: 4px;
        }

        /* === CARD === */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            margin-bottom: 12px;
            animation: fadeSlideUp 0.5s ease both;
        }

        .card:nth-child(1) { animation-delay: 0.05s; }
        .card:nth-child(2) { animation-delay: 0.1s; }
        .card:nth-child(3) { animation-delay: 0.15s; }

        .card-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--accent-light);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-title::before {
            content: '';
            display: inline-block;
            width: 3px;
            height: 12px;
            background: linear-gradient(to bottom, var(--accent), var(--accent-2));
            border-radius: 2px;
        }

        /* === FORM GROUPS === */
        .form-group {
            margin-bottom: 14px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 500;
            color: var(--tg-hint);
            margin-bottom: 7px;
            letter-spacing: 0.3px;
        }

        label .icon {
            font-size: 14px;
            opacity: 0.7;
        }

        .input-wrapper {
            position: relative;
        }

        input, select {
            width: 100%;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--tg-text);
            font-family: 'IBM Plex Sans Arabic', sans-serif;
            font-size: 15px;
            font-weight: 400;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            appearance: none;
            outline: none;
        }

        input:focus, select:focus {
            border-color: var(--border-focus);
            background: rgba(212, 98, 30, 0.06);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        input::placeholder {
            color: rgba(242,237,228,0.2);
        }

        /* Custom select arrow */
        .select-wrapper {
            position: relative;
        }

        .select-wrapper::after {
            content: '‚ñæ';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--tg-hint);
            font-size: 12px;
            pointer-events: none;
        }

        /* Date input */
        input[type="date"] {
            color-scheme: dark;
        }

        /* Number input */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
        }

        /* === ROW === */
        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* === SERVICE PRESETS === */
        .presets-label {
            font-size: 11px;
            color: var(--tg-hint);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .presets {
            display: flex;
            flex-wrap: wrap;
            gap: 7px;
            margin-bottom: 14px;
        }

        .preset-chip {
            padding: 5px 11px;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 12px;
            font-family: 'IBM Plex Sans Arabic', sans-serif;
            color: var(--tg-hint);
            cursor: pointer;
            transition: all 0.18s ease;
            white-space: nowrap;
        }

        .preset-chip:hover, .preset-chip.active {
            background: var(--accent-glow);
            border-color: var(--accent);
            color: var(--cream);
        }

        /* === COST DISPLAY === */
        .cost-preview {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: rgba(212, 98, 30, 0.07);
            border: 1px solid rgba(212, 98, 30, 0.2);
            border-radius: var(--radius-sm);
            margin-top: 10px;
        }

        .cost-preview.visible {
            display: flex;
        }

        .cost-preview .label {
            font-size: 12px;
            color: var(--tg-hint);
        }

        .cost-preview .amount {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-light);
        }

        /* === CYCLE TOGGLE === */
        .cycle-toggle {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            overflow: hidden;
            padding: 3px;
            gap: 3px;
        }

        .cycle-option {
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--tg-hint);
            transition: all 0.2s ease;
            font-family: 'IBM Plex Sans Arabic', sans-serif;
        }

        .cycle-option.active {
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            color: #fff;
            box-shadow: 0 2px 12px var(--accent-glow);
        }

        /* === SAVE BUTTON === */
        .btn-container {
            position: fixed;
            bottom: 0;
            right: 0;
            left: 0;
            padding: 12px 16px 20px;
            background: linear-gradient(to top, var(--tg-bg) 70%, transparent);
            z-index: 10;
        }

        .btn-save {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            display: block;
            padding: 15px 24px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
            color: #fff;
            border: none;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            font-family: 'IBM Plex Sans Arabic', sans-serif;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 24px var(--accent-glow);
            transition: all 0.2s ease;
            letter-spacing: 0.2px;
        }

        .btn-save::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.12) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .btn-save:active {
            transform: scale(0.97);
            box-shadow: 0 2px 12px var(--accent-glow);
        }

        .btn-save:active::before {
            opacity: 1;
        }

        .btn-save.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-save .btn-icon {
            margin-left: 8px;
        }

        /* === STATUS INDICATOR === */
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-light);
            display: inline-block;
            margin-left: 6px;
            box-shadow: 0 0 6px var(--accent-glow);
            animation: blink 2s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* === ANIMATIONS === */
        @keyframes fadeSlideDown {
            from { opacity: 0; transform: translateY(-16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeSlideUp {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* === REQUIRED FIELD === */
        .required {
            color: var(--danger);
            margin-right: 2px;
        }

        /* === SUCCESS STATE === */
        .success-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 100;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
            backdrop-filter: blur(10px);
        }

        .success-overlay.show {
            display: flex;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            box-shadow: 0 0 40px var(--accent-glow);
            animation: successPop 0.4s cubic-bezier(0.34,1.56,0.64,1);
        }

        @keyframes successPop {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .success-text {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            text-align: center;
        }

        .success-sub {
            font-size: 13px;
            color: var(--tg-hint);
        }

        /* === DIVIDER === */
        .divider {
            height: 1px;
            background: var(--border);
            margin: 14px 0;
        }
    </style>
</head>
<body>

    <div class="container">

        <!-- Header -->
        <div class="header">
            <div class="header-icon">
                <!-- Circuit S Logo recreated from brand -->
                <svg viewBox="0 0 44 56" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- Vertical rails -->
                    <rect x="17" y="2" width="3" height="8" rx="1" fill="#1a1a1a"/>
                    <rect x="24" y="2" width="3" height="8" rx="1" fill="#d4621e"/>
                    <!-- Top node dot -->
                    <circle cx="22" cy="3.5" r="2" fill="#d4621e" stroke="#111008" stroke-width="0.8"/>
                    <!-- S shape top curve -->
                    <path d="M28 10 Q34 10 34 17 Q34 24 22 24 Q10 24 10 31 Q10 38 16 38" stroke="#1a1a1a" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                    <path d="M30 10 Q36 10 36 17 Q36 26 22 26 Q8 26 8 33 Q8 40 14 40" stroke="#d4621e" stroke-width="2" stroke-linecap="round" fill="none"/>
                    <!-- Middle node dot -->
                    <circle cx="22" cy="27" r="2" fill="#d4621e" stroke="#111008" stroke-width="0.8"/>
                    <!-- S bottom -->
                    <path d="M16 40 Q10 40 10 46" stroke="#1a1a1a" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                    <path d="M14 40 Q8 42 8 46" stroke="#d4621e" stroke-width="2" stroke-linecap="round" fill="none"/>
                    <!-- Bottom verticals -->
                    <rect x="17" y="46" width="3" height="8" rx="1" fill="#1a1a1a"/>
                    <rect x="24" y="46" width="3" height="8" rx="1" fill="#d4621e"/>
                    <!-- Bottom node dot -->
                    <circle cx="22" cy="52.5" r="2" fill="#d4621e" stroke="#111008" stroke-width="0.8"/>
                    <!-- Side connector lines -->
                    <line x1="34" y1="13" x2="40" y2="13" stroke="#d4621e" stroke-width="1.5" stroke-linecap="round" opacity="0.6"/>
                    <line x1="4" y1="43" x2="10" y2="43" stroke="#d4621e" stroke-width="1.5" stroke-linecap="round" opacity="0.6"/>
                    <circle cx="41" cy="13" r="1.5" fill="#d4621e" opacity="0.7"/>
                    <circle cx="3" cy="43" r="1.5" fill="#d4621e" opacity="0.7"/>
                </svg>
            </div>
            <h1>Subscription Manager</h1>
            <p>ÿ£ÿ∂ŸÅ ÿßÿ¥ÿ™ÿ±ÿßŸÉÿßŸã ÿ¨ÿØŸäÿØÿßŸã <span class="status-dot"></span></p>
        </div>

        <!-- Card 1: Service Info -->
        <div class="card">
            <div class="card-title">ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿÆÿØŸÖÿ©</div>

            <div class="presets-label">ÿßÿÆÿ™Ÿäÿßÿ± ÿ≥ÿ±Ÿäÿπ</div>
            <div class="presets">
                <button class="preset-chip" onclick="setPreset('Netflix', 15.99)">üé¨ Netflix</button>
                <button class="preset-chip" onclick="setPreset('Spotify', 9.99)">üéµ Spotify</button>
                <button class="preset-chip" onclick="setPreset('YouTube Premium', 13.99)">‚ñ∂Ô∏è YouTube</button>
                <button class="preset-chip" onclick="setPreset('ChatGPT Plus', 20)">ü§ñ ChatGPT</button>
                <button class="preset-chip" onclick="setPreset('iCloud', 2.99)">‚òÅÔ∏è iCloud</button>
                <button class="preset-chip" onclick="setPreset('Adobe CC', 54.99)">üé® Adobe</button>
            </div>

            <div class="form-group">
                <label><span class="icon">üìå</span> ÿßÿ≥ŸÖ ÿßŸÑÿÆÿØŸÖÿ© <span class="required">*</span></label>
                <input type="text" id="service_name" placeholder="ŸÖÿ´ÿßŸÑ: Netflix" autocomplete="off">
            </div>
        </div>

        <!-- Card 2: Cost & Currency -->
        <div class="card">
            <div class="card-title">ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ŸàÿßŸÑÿπŸÖŸÑÿ©</div>

            <div class="row">
                <div class="form-group">
                    <label><span class="icon">üí∞</span> ÿßŸÑŸÖÿ®ŸÑÿ∫ <span class="required">*</span></label>
                    <input type="number" id="cost" step="0.01" placeholder="0.00" min="0" oninput="updatePreview()">
                </div>
                <div class="form-group">
                    <label><span class="icon">üåê</span> ÿßŸÑÿπŸÖŸÑÿ©</label>
                    <div class="select-wrapper">
                        <select id="currency" onchange="updatePreview()">
                            <option value="USD">USD ($)</option>
                            <option value="SAR">SAR (ÿ±.ÿ≥)</option>
                            <option value="MAD">MAD (ÿØ.ŸÖ)</option>
                            <option value="EGP">EGP (ÿ¨.ŸÖ)</option>
                            <option value="EUR">EUR (‚Ç¨)</option>
                            <option value="AED">AED (ÿØ.ÿ•)</option>
                            <option value="KWD">KWD (ÿØ.ŸÉ)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="cost-preview" id="costPreview">
                <span class="label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿ≥ŸÜŸàŸä</span>
                <span class="amount" id="yearlyAmount">‚Äî</span>
            </div>
        </div>

        <!-- Card 3: Schedule -->
        <div class="card">
            <div class="card-title">ÿ¨ÿØŸàŸÑ ÿßŸÑÿØŸÅÿπ</div>

            <div class="form-group">
                <label><span class="icon">üîÑ</span> ÿØŸàÿ±ÿ© ÿßŸÑÿØŸÅÿπ</label>
                <div class="cycle-toggle">
                    <div class="cycle-option active" id="cycle-monthly" onclick="setCycle('monthly')">ÿ¥Ÿáÿ±Ÿä</div>
                    <div class="cycle-option" id="cycle-yearly" onclick="setCycle('yearly')">ÿ≥ŸÜŸàŸä</div>
                </div>
                <input type="hidden" id="cycle" value="monthly">
            </div>

            <div class="divider"></div>

            <div class="form-group">
                <label><span class="icon">üìÖ</span> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÇÿßÿØŸÖ <span class="required">*</span></label>
                <input type="date" id="date">
            </div>
        </div>

    </div>

    <!-- Save Button -->
    <div class="btn-container">
        <button class="btn-save" id="saveBtn" onclick="sendData()">
            <span class="btn-icon">‚ú¶</span> ÿ≠ŸÅÿ∏ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ
        </button>
    </div>

    <!-- Success Overlay -->
    <div class="success-overlay" id="successOverlay">
        <div class="success-icon">‚úì</div>
        <div class="success-text">ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏ ÿ®ŸÜÿ¨ÿßÿ≠!</div>
        <div class="success-sub">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ...</div>
    </div>

    <script>
        // === TELEGRAM INIT ===
        let tg = window.Telegram?.WebApp;

        if (tg) {
            tg.expand();
            tg.ready();

            // Apply Telegram theme
            const isDark = tg.colorScheme === 'dark';
            if (!isDark) {
                document.documentElement.style.setProperty('--surface', 'rgba(0,0,0,0.04)');
                document.documentElement.style.setProperty('--border', 'rgba(0,0,0,0.08)');
            }
        }

        // === DEFAULT DATE ===
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;

        // === PRESETS ===
        function setPreset(name, cost) {
            document.getElementById('service_name').value = name;
            document.getElementById('cost').value = cost;

            // Highlight chip
            document.querySelectorAll('.preset-chip').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');

            updatePreview();
        }

        // === CYCLE TOGGLE ===
        function setCycle(val) {
            document.getElementById('cycle').value = val;
            document.getElementById('cycle-monthly').classList.toggle('active', val === 'monthly');
            document.getElementById('cycle-yearly').classList.toggle('active', val === 'yearly');
            updatePreview();
        }

        // === COST PREVIEW ===
        const currencySymbols = {
            USD: '$', SAR: 'ÿ±.ÿ≥', MAD: 'ÿØ.ŸÖ', EGP: 'ÿ¨.ŸÖ',
            EUR: '‚Ç¨', AED: 'ÿØ.ÿ•', KWD: 'ÿØ.ŸÉ'
        };

        function updatePreview() {
            const cost = parseFloat(document.getElementById('cost').value);
            const currency = document.getElementById('currency').value;
            const cycle = document.getElementById('cycle').value;
            const preview = document.getElementById('costPreview');
            const yearlyEl = document.getElementById('yearlyAmount');

            if (cost && cost > 0) {
                const yearly = cycle === 'monthly' ? cost * 12 : cost;
                const symbol = currencySymbols[currency] || currency;
                yearlyEl.textContent = `${yearly.toFixed(2)} ${symbol}`;
                preview.classList.add('visible');
            } else {
                preview.classList.remove('visible');
            }
        }

        // === SEND DATA ===
        function sendData() {
            const name = document.getElementById('service_name').value.trim();
            const cost = document.getElementById('cost').value;
            const currency = document.getElementById('currency').value;
            const cycle = document.getElementById('cycle').value;
            const date = document.getElementById('date').value;

            // Validation
            if (!name || !cost || !date) {
                if (tg) {
                    tg.showPopup({
                        title: '‚ö†Ô∏è ÿ≠ŸÇŸàŸÑ ŸÖÿ∑ŸÑŸàÿ®ÿ©',
                        message: 'Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑÿ•ŸÑÿ≤ÿßŸÖŸäÿ© (ÿßÿ≥ŸÖ ÿßŸÑÿÆÿØŸÖÿ©ÿå ÿßŸÑÿ™ŸÉŸÑŸÅÿ©ÿå ÿßŸÑÿ™ÿßÿ±ŸäÿÆ)',
                        buttons: [{ type: 'ok' }]
                    });
                } else {
                    alert('Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ');
                }
                return;
            }

            if (parseFloat(cost) <= 0) {
                if (tg) {
                    tg.showPopup({
                        title: '‚ö†Ô∏è ŸÇŸäŸÖÿ© ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©',
                        message: 'Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿ£ŸÉÿ®ÿ± ŸÖŸÜ ÿµŸÅÿ±',
                        buttons: [{ type: 'ok' }]
                    });
                }
                return;
            }

            const data = {
                service_name: name,
                cost: parseFloat(parseFloat(cost).toFixed(2)),
                currency: currency,
                billing_cycle: cycle,
                next_payment_date: date
            };

            // Show loading
            const btn = document.getElementById('saveBtn');
            btn.classList.add('loading');
            btn.innerHTML = '‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...';

            // Small delay for UX polish, then send
            setTimeout(() => {
                if (tg) {
                    // Show success briefly
                    document.getElementById('successOverlay').classList.add('show');
                    setTimeout(() => {
                        tg.sendData(JSON.stringify(data));
                    }, 800);
                } else {
                    // Dev mode fallback
                    console.log('Data to send:', data);
                    document.getElementById('successOverlay').classList.add('show');
                    setTimeout(() => {
                        document.getElementById('successOverlay').classList.remove('show');
                        btn.classList.remove('loading');
                        btn.innerHTML = '<span class="btn-icon">‚ú¶</span> ÿ≠ŸÅÿ∏ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ';
                    }, 2000);
                }
            }, 300);
        }

        // Deselect preset chip when user types manually
        document.getElementById('service_name').addEventListener('input', function() {
            if (!document.querySelectorAll('.preset-chip.active').length) return;
            const chips = document.querySelectorAll('.preset-chip');
            const val = this.value.trim();
            let matched = false;
            chips.forEach(c => {
                const chipName = c.textContent.replace(/^[^\w]+ /, '').trim();
                if (val.toLowerCase() === chipName.toLowerCase()) {
                    c.classList.add('active');
                    matched = true;
                } else {
                    c.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
